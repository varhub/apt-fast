urldecode() # $1=<string>
{
    local url_encoded="${1//+/ }"
    printf '%b' "${url_encoded//%/\\x}"
}

mode=install
apt-get --print-uris $mode "$@" | while read pkg_uri_info
  do
  # --print-uris format is: 'fileurl' filename filesize checksum_hint:filechecksum
    uri=$(echo "$pkg_uri_info" | cut -d' ' -f1 | tr -d "'")
    filename=$(echo "$pkg_uri_info" | cut -d' ' -f2)
    # whole uri comes encoded (urlencoded). At least for filename decode it is
    # mandatory due filename is used for `wget -O <filename>`. Futhermore, md5
    # patch requires decoded package name and version to work.
    filename=$(urldecode $filename)
    filesize=$(echo "$pkg_uri_info" | cut -d' ' -f3)
    checksum=$(echo "$pkg_uri_info" | cut -d' ' -f4 | cut -d':' -f2)

    ## Aria only supports md5 and sha1. If --print-uris return other than
    # MD5, we need to replace it (by now behavior is return strongest).
    # Using apt-cache show package=version to ensure recover single and
    # correct package version.
    # Warning: assuming that package naming uses '_' as field separator.
    # Therefore, this code expects package-name_version_arch.deb Otherways
    # below code will fail resoundingly
    if echo "$pkg_uri_info" | grep -q -v 'MD5Sum'
    then
      pkg_name=$(echo "$filename" | cut -d'_' -f1)
      pkg_version=$(echo "$filename" | cut -d'_' -f2)
      pkg_version=$(urldecode $pkg_version)
cat<<EOF
patching md5 for $filename
  name:    $pkg_name
  version: $pkg_version
EOF
      patch_md5=$(apt-cache show $pkg_name=$pkg_version | grep MD5sum | head -n 1)
      checksum=$(echo $patch_md5 | cut -d' ' -f2)
    fi

cat<<EOF
$pkg_uri_info
  $filename
  $uri
  $checksum

EOF

done
